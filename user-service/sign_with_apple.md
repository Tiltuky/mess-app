
# Процесс авторизации через Sign with Apple 
- Пользователь переходит по кнопке Sign with Apple
- Пользователь проходит аутентификацию
- Если авторизация происходит через iOS устройство, то переходим к следующему пункту.
  Если авторизация происходит через Web форму, то запрос перенаправляется на redirectURI и передает параметры:
- В ответ получаем: 
  - authorization code - одноразовый код аутентификации пользователя, 
    который действует в течение 5 минут.
  - state — идентификатор сессии, отправленный при создании формы авторизации 
  - user — данные пользователя.
- Имея authorization code необходимо запросить access_token.
  Для этого по адресу https://appleid.apple.com/auth/token направляем запрос содержащий:
    - client_id указывается созданный для web-приложений ServiceID и AppID для iOS-приложения.
    - code — мы получили выше
    - grant_type передаем цель получения токена: авторизация (authorization_code) или продление токена (refresh_token)
    - client_secret — JSON Web Tokens на основе секретного ключа, полученного при регистрации приложения в Apple Developer.
- В ответ получаем access_token, refresh_token и id_token(информация о пользователе храниться здесь)
- Для раскодирования id_token  необходим Apple_public_key это публичный ключ, который можно получить: "GET https://appleid.apple.com/auth/keys"
- после расшифровки получаем данные вида:
  ```
  data = {
  "iss": "https://appleid.apple.com",
  "aud": client_id,
  "exp": 1570379521,
  "iat": 1570378921,
  "sub": "уникальный идентификатор пользователя",
  "at_hash": "8ZDF6j786IQf9mA",
  "email": "someemail@gmail.com",
  "email_verified": "true",
  "auth_time": 1570378804
  }
- Токен необходимо валидировать, чтобы убедиться что его не подменили
- Из токена можем получить уникальный Apple ID и Email(выдается только при первом запросе токена)
- На основании этих данный производится регистрация или авторизация пользователя

# Настройка в Apple Developer Console
- Зарегистрируйтесь как разработчик в [Apple Developer](https://developer.apple.com/)
- Создайте новый идентификатор приложения (App ID).
- Включите "Sign in with Apple" для вашего App ID.
- Создайте идентификатор службы (Service ID).
- Настройте redirectURI для вашей службы.
- Получите ключ (private key) в формате .p8 и идентификатор ключа (key ID).

# Технические аспекты
- Необходимо реализовать redirectURI для обработки авторизации
- Для валидации токена можно использовать библиотеку https://github.com/Timothylock/go-signin-with-apple